# âœ… Latihan PHP â€“ Aplikasi Todo List (CRUD + PostgreSQL)

Aplikasi Todo List sederhana menggunakan **PHP Native (tanpa framework)** dengan arsitektur **MVC sederhana** dan database **PostgreSQL**. Aplikasi ini memiliki fitur CRUD (Create, Read, Update, Delete) dan sudah menggunakan tampilan Bootstrap.

---

## ðŸš€ Teknologi yang Digunakan
| Komponen        | Versi / Teknologi |
|-----------------|-------------------|
| Bahasa Pemrograman | PHP 8.x |
| Database        | PostgreSQL 16 |
| Frontend        | Bootstrap 5.3 |
| Arsitektur      | MVC sederhana |
| Web Server      | PHP Built-in Server (`php -S`) |

---

## âš™ï¸ Konfigurasi Database PostgreSQL

Buat database `db_todo`, lalu jalankan SQL berikut:

```sql
SET search_path TO public;

-- 1) Pastikan tabel ada
CREATE TABLE IF NOT EXISTS public.todo (
  id          INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  title       VARCHAR(250) NULL,              -- nanti dipaksa NOT NULL
  description TEXT,
  is_finished BOOLEAN,
  created_at  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
  sort_order  INT          NOT NULL DEFAULT 0
);

-- 2) activity -> title (kalau activity masih ada)
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='todo' AND column_name='activity'
  ) THEN
    -- kalau title belum ada, buat dulu agar bisa copy nilai
    IF NOT EXISTS (
      SELECT 1 FROM information_schema.columns
      WHERE table_schema='public' AND table_name='todo' AND column_name='title'
    ) THEN
      ALTER TABLE public.todo ADD COLUMN title VARCHAR(250);
    END IF;

    EXECUTE 'UPDATE public.todo SET title = COALESCE(NULLIF(title, ''''), activity)';
    ALTER TABLE public.todo DROP COLUMN activity;
  END IF;
END $$;

-- 3) status (0/1) -> is_finished (boolean)
DO $$
DECLARE v_type text;
BEGIN
  -- jika masih ada kolom "status" dan belum ada "is_finished"
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='todo' AND column_name='status'
  ) AND NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='todo' AND column_name='is_finished'
  ) THEN
    ALTER TABLE public.todo ADD COLUMN is_finished BOOLEAN NOT NULL DEFAULT FALSE;
    EXECUTE 'UPDATE public.todo SET is_finished = (COALESCE(status::int,0) = 1)';
    ALTER TABLE public.todo DROP COLUMN status;
  ELSE
    -- jika "is_finished" sudah ada tapi bukan boolean, ubah dengan casting aman
    SELECT data_type INTO v_type
    FROM information_schema.columns
    WHERE table_schema='public' AND table_name='todo' AND column_name='is_finished';

    IF v_type IS NOT NULL AND v_type <> 'boolean' THEN
      EXECUTE 'ALTER TABLE public.todo ALTER COLUMN is_finished DROP DEFAULT';
      EXECUTE 'ALTER TABLE public.todo ALTER COLUMN is_finished TYPE boolean USING (COALESCE(is_finished::int,0) = 1)';
      EXECUTE 'ALTER TABLE public.todo ALTER COLUMN is_finished SET DEFAULT FALSE';
    ELSIF v_type IS NULL THEN
      -- kolom belum ada sama sekali
      ALTER TABLE public.todo ADD COLUMN is_finished BOOLEAN NOT NULL DEFAULT FALSE;
    END IF;
  END IF;
END $$;

-- 4) Pastikan kolom-kolom final ada
ALTER TABLE public.todo
  ADD COLUMN IF NOT EXISTS description TEXT,
  ADD COLUMN IF NOT EXISTS sort_order  INT NOT NULL DEFAULT 0;

-- 5) Paksa constraint NOT NULL yang diperlukan
ALTER TABLE public.todo
  ALTER COLUMN title       SET NOT NULL,
  ALTER COLUMN is_finished SET NOT NULL;

-- 6) Inisialisasi sort_order untuk baris yang masih 0
UPDATE public.todo SET sort_order = id WHERE sort_order = 0;

-- 7) Rapikan duplikat title (case-insensitive) agar index unik bisa dibuat
WITH d AS (
  SELECT id, title, LOWER(title) lt,
         ROW_NUMBER() OVER (PARTITION BY LOWER(title) ORDER BY id) rn
  FROM public.todo
)
UPDATE public.todo t
SET title = t.title || ' (' || (d.rn - 1) || ')'
FROM d
WHERE t.id = d.id AND d.rn > 1;

-- 8) Index unik judul
CREATE UNIQUE INDEX IF NOT EXISTS todo_title_unique ON public.todo (LOWER(title));

-- 9) Trigger updated_at otomatis saat UPDATE
CREATE OR REPLACE FUNCTION public.update_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at := CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS update_todo_timestamp ON public.todo;
CREATE TRIGGER update_todo_timestamp
BEFORE UPDATE ON public.todo
FOR EACH ROW
EXECUTE FUNCTION public.update_timestamp();
